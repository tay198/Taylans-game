<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Assistant - Enhanced</title>
    <style>
        :root {
            --body-bg-light: #f4f6f8;
            --body-bg-dark: #121212; /* Darker dark mode */
            --chat-bg-light: #ffffff;
            --chat-bg-dark: #1e1e1e;
            --header-bg-light: #007bff;
            --header-bg-dark: #0056b3;
            --header-text-light: #ffffff;
            --header-text-dark: #e0e0e0;
            --user-msg-bg-light: #007bff;
            --user-msg-bg-dark: #0056b3;
            --user-msg-text-light: #ffffff;
            --user-msg-text-dark: #e0e0e0;
            --bot-msg-bg-light: #e9ecef;
            --bot-msg-bg-dark: #3a3a3a; /* Slightly lighter bot message in dark */
            --bot-msg-text-light: #333333;
            --bot-msg-text-dark: #d0d0d0;
            --input-bg-light: #ffffff;
            --input-bg-dark: #2c2c2c;
            --input-text-light: #333333;
            --input-text-dark: #e0e0e0;
            --input-border-light: #ced4da;
            --input-border-dark: #555555;
            --button-bg-light: #007bff;
            --button-bg-dark: #0056b3;
            --button-text-light: #ffffff;
            --button-text-dark: #e0e0e0;
            --text-color-light: #212529;
            --text-color-dark: #f8f9fa;
            --border-color-light: #dee2e6;
            --border-color-dark: #444444;
            --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-dark: 0 2px 10px rgba(0,0,0,0.4); /* Darker shadow for dark mode */
            --icon-filter-light: invert(0%);
            --icon-filter-dark: invert(100%);

            /* Apply light theme by default */
            --body-bg: var(--body-bg-light);
            --chat-bg: var(--chat-bg-light);
            --header-bg: var(--header-bg-light);
            --header-text: var(--header-text-light);
            --user-msg-bg: var(--user-msg-bg-light);
            --user-msg-text: var(--user-msg-text-light);
            --bot-msg-bg: var(--bot-msg-bg-light);
            --bot-msg-text: var(--bot-msg-text-light);
            --input-bg: var(--input-bg-light);
            --input-text: var(--input-text-light);
            --input-border: var(--input-border-light);
            --button-bg: var(--button-bg-light);
            --button-text: var(--button-text-light);
            --text-color: var(--text-color-light);
            --border-color: var(--border-color-light);
            --shadow: var(--shadow-light);
            --icon-filter: var(--icon-filter-light);
        }

        body.dark-mode {
            --body-bg: var(--body-bg-dark);
            --chat-bg: var(--chat-bg-dark);
            --header-bg: var(--header-bg-dark);
            --header-text: var(--header-text-dark);
            --user-msg-bg: var(--user-msg-bg-dark);
            --user-msg-text: var(--user-msg-text-dark);
            --bot-msg-bg: var(--bot-msg-bg-dark);
            --bot-msg-text: var(--bot-msg-text-dark);
            --input-bg: var(--input-bg-dark);
            --input-text: var(--input-text-dark);
            --input-border: var(--input-border-dark);
            --button-bg: var(--button-bg-dark);
            --button-text: var(--button-text-dark);
            --text-color: var(--text-color-dark);
            --border-color: var(--border-color-dark);
            --shadow: var(--shadow-dark);
            --icon-filter: var(--icon-filter-dark);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: var(--body-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }

        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 100vh; 
            background-color: var(--chat-bg);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        .chat-header {
            padding: 12px 20px; /* Reduced padding */
            background-color: var(--header-bg);
            color: var(--header-text);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        .chat-header h2 {
            font-size: 1.1em; /* Adjusted size */
            margin: 0;
        }

        #theme-toggle {
            background: none;
            border: 1px solid var(--header-text);
            color: var(--header-text);
            padding: 6px 10px;
            border-radius: 20px; /* More rounded */
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        #theme-toggle:hover {
            background-color: var(--header-text);
            color: var(--header-bg);
        }
        #theme-toggle .icon {
            font-size: 1.1em;
        }

        .chat-window {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--button-bg) var(--chat-bg);
        }
        .chat-window::-webkit-scrollbar { width: 8px; }
        .chat-window::-webkit-scrollbar-track { background: var(--chat-bg); }
        .chat-window::-webkit-scrollbar-thumb {
            background-color: var(--button-bg);
            border-radius: 10px;
            border: 2px solid var(--chat-bg);
        }

        .message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 75%;
            line-height: 1.5;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInMessage 0.3s ease forwards;
            word-wrap: break-word;
        }
        .message.fade-out {
            animation: fadeOutMessage 0.3s ease forwards;
        }

        @keyframes fadeInMessage {
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOutMessage {
            to { opacity: 0; transform: translateY(-5px); height: 0; padding-top: 0; padding-bottom: 0; margin-bottom: 0; }
        }


        .message.user {
            background-color: var(--user-msg-bg);
            color: var(--user-msg-text);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }

        .message.bot {
            background-color: var(--bot-msg-bg);
            color: var(--bot-msg-text);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        .message.bot.typing .dot { /* Changed class for clarity */
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor; /* Use message text color */
            animation: bounceTyping 1.2s infinite ease-in-out;
            margin: 0 2px;
        }
        .message.bot.typing .dot:nth-child(1) { animation-delay: 0s; }
        .message.bot.typing .dot:nth-child(2) { animation-delay: 0.2s; }
        .message.bot.typing .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounceTyping {
            0%, 60%, 100% { transform: scale(0.4); opacity: 0.5; }
            30% { transform: scale(1.0); opacity: 1; }
        }

        .chat-input-form { /* Renamed for clarity with form tag */
            display: flex;
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--chat-bg);
            transition: background-color 0.3s, border-color 0.3s;
            flex-shrink: 0; /* Prevent input area from shrinking */
        }

        #userInput {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--input-border);
            border-radius: 20px;
            font-size: 1em;
            background-color: var(--input-bg);
            color: var(--input-text);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            margin-right: 10px;
        }
        #userInput:focus {
            outline: none;
            border-color: var(--button-bg);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--button-bg) 25%, transparent);
        }

        #sendButton {
            padding: 12px 20px;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.2s, opacity 0.2s;
        }
        #sendButton:hover:not(:disabled) {
            opacity: 0.85;
        }
        #sendButton:disabled {
            background-color: color-mix(in srgb, var(--button-bg) 50%, #888);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Mobile responsiveness */
        @media (min-width: 801px) {
            .chat-container {
                border-radius: 8px;
                height: calc(100vh - 40px);
                margin: 20px auto;
            }
        }

        @media (max-width: 600px) {
            .chat-header h2 { font-size: 1em; }
            #theme-toggle { padding: 5px 8px; font-size: 0.85em; }
            .message { max-width: 90%; font-size: 0.95em; }
            #userInput, #sendButton { font-size: 0.95em; }
            .chat-input-form { padding: 10px 15px; }
            .chat-window { padding: 15px 10px; }
        }
    </style>
</head>
<body>

    <div class="chat-container">
        <header class="chat-header">
            <h2>AI Assistant</h2>
            <button id="theme-toggle" aria-label="Toggle color theme">
                <span class="icon"></span> <span class="text">Toggle Theme</span>
            </button>
        </header>
        <div class="chat-window" id="chatWindow" role="log" aria-live="polite">
        </div>
        <form class="chat-input-form" id="chatForm">
            <input type="text" id="userInput" placeholder="Type your message..." autocomplete="off" aria-label="User message input">
            <button type="submit" id="sendButton" aria-label="Send message">Send</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatWindow = document.getElementById('chatWindow');
            const userInput = document.getElementById('userInput');
            const chatForm = document.getElementById('chatForm'); // Changed from sendButton direct listener
            const sendButton = document.getElementById('sendButton');
            const themeToggleButton = document.getElementById('theme-toggle');
            const themeToggleIcon = themeToggleButton.querySelector('.icon');
            const themeToggleText = themeToggleButton.querySelector('.text');

            let conversationHistory = [];
            let userName = localStorage.getItem('userName') || null;
            let aiTemperature = "balanced"; // "safe", "balanced", "creative"
            let initialFocusDone = false;
            const MAX_MESSAGES = 50; // For pruning old messages

            // --- INITIAL GREETING & SETUP ---
            function initializeChat() {
                loadTheme();
                const greeting = userName 
                    ? `Welcome back, ${userName}! How can I help you today?`
                    : "Hello! I'm your friendly AI Assistant. How can I assist you?";
                addMessageToChat(greeting, 'bot');
                conversationHistory.push({ role: 'assistant', content: greeting });
                
                if (!initialFocusDone) {
                    userInput.focus();
                    initialFocusDone = true;
                }
                // Attempt to handle mobile keyboard pushback slightly by scrolling after focus
                setTimeout(scrollToBottom, 100); 
            }

            // --- ADD MESSAGE TO CHAT UI ---
            function addMessageToChat(text, sender, isTyping = false) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', sender);

                if (isTyping) {
                    messageElement.classList.add('typing');
                    messageElement.innerHTML = `<span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
                    messageElement.setAttribute('aria-label', 'Bot is typing');
                } else {
                    if (sender === 'user') {
                        messageElement.textContent = text; // Use textContent for user messages (security)
                    } else {
                        // For bot, allow simple bold/italics via innerHTML. Sanitize if source is untrusted.
                        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
                        messageElement.innerHTML = text;
                    }
                }
                
                chatWindow.appendChild(messageElement);
                pruneOldMessages();
                scrollToBottom();
                return messageElement;
            }
            
            // --- PRUNE OLD MESSAGES ---
            function pruneOldMessages() {
                while (chatWindow.children.length > MAX_MESSAGES) {
                    chatWindow.removeChild(chatWindow.firstChild);
                }
                if (conversationHistory.length > MAX_MESSAGES) {
                    conversationHistory = conversationHistory.slice(conversationHistory.length - MAX_MESSAGES);
                }
            }

            // --- SCROLL TO BOTTOM ---
            function scrollToBottom() {
                // A slight delay can sometimes help ensure rendering is complete before scrolling
                setTimeout(() => { 
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }, 0);
            }
            
            // --- AI RESPONSE SIMULATION ---
            function getSynonym(baseWord, options) {
                return options[Math.floor(Math.random() * options.length)];
            }

            async function getAIResponse(prompt) {
                const typingIndicator = addMessageToChat('', 'bot', true);
                sendButton.disabled = true;
                userInput.disabled = true;

                // Simulate API call delay 
                await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1200));

                // Smoother typing indicator removal
                if (typingIndicator) {
                    typingIndicator.classList.add('fade-out');
                    setTimeout(() => {
                        if (typingIndicator.parentNode) { // Check if still in DOM
                           typingIndicator.remove();
                        }
                    }, 300); // Match fadeOutMessage animation duration
                }

                sendButton.disabled = false;
                userInput.disabled = false;
                // userInput.focus(); // Removed auto-focus after every message

                let response = "I'm not quite sure how to respond to that. Could you try rephrasing?";
                const lowerPrompt = prompt.toLowerCase();

                // Improved Name Extraction
                if (lowerPrompt.includes("my name is")) {
                    const nameMatch = lowerPrompt.match(/my name is ([\w\s']+)/i);
                    if (nameMatch && nameMatch[1]) {
                        userName = nameMatch[1].split(' ').map(n => n.charAt(0).toUpperCase() + n.slice(1)).join(' ');
                        localStorage.setItem('userName', userName);
                        response = `${getSynonym("Nice to meet you", ["Great to meet you", "Pleasure to meet you", "Hello"])} ${userName}! What can I do for you?`;
                    }
                } else if (lowerPrompt.includes("call me")) {
                     const nameMatch = lowerPrompt.match(/call me ([\w\s']+)/i);
                    if (nameMatch && nameMatch[1]) {
                        userName = nameMatch[1].split(' ').map(n => n.charAt(0).toUpperCase() + n.slice(1)).join(' ');
                        localStorage.setItem('userName', userName);
                        response = `Alright, ${userName}! How can I help?`;
                    }
                }

                // Command/Plugin System Placeholder
                if (prompt.startsWith('/')) {
                    const [command, ...args] = prompt.substring(1).split(' ');
                    switch (command.toLowerCase()) {
                        case 'weather':
                            response = `I can't check the real weather yet, but let's imagine it's sunny! (args: ${args.join(' ')})`;
                            break;
                        case 'joke':
                            response = getJoke();
                            break;
                        case 'temp':
                            if (args[0] && ["safe", "balanced", "creative"].includes(args[0].toLowerCase())) {
                                aiTemperature = args[0].toLowerCase();
                                response = `AI temperature set to: ${aiTemperature}.`;
                            } else {
                                response = `Current AI temperature is ${aiTemperature}. Use /temp [safe|balanced|creative].`;
                            }
                            break;
                        default:
                            response = `Unknown command: ${command}`;
                    }
                } else { // Regular conversation
                    const greetings = ["hello", "hi", "hey", "greetings"];
                    if (greetings.some(g => lowerPrompt.startsWith(g))) {
                        response = userName ? `${getSynonym("Hello", ["Hi", "Hey there"])} ${userName}! ${getSynonym("How can I help?", ["What's up?", "How can I assist?"])}` 
                                          : `${getSynonym("Hello", ["Hi there", "Greetings"])}! ${getSynonym("How can I assist you?", ["What can I do for you?", "How can I help?"])}`;
                    } else if (lowerPrompt.includes("what is your name") || lowerPrompt.includes("who are you")) {
                        response = "I am AI Assistant 3000, your virtual helper.";
                    } else if (lowerPrompt.includes("how are you")) {
                        const feelingOptions = ["I'm functioning optimally", "I'm doing well", "I'm ready to assist"];
                        response = `${feelingOptions[Math.floor(Math.random() * feelingOptions.length)]}, thank you!`;
                    } else if (lowerPrompt.includes("what can you do") || lowerPrompt.includes("help")) {
                        response = "I can chat with you, remember your name (if you tell me!), tell jokes (/joke), and simulate different response styles (/temp).";
                    } else if (lowerPrompt.includes("bye") || lowerPrompt.includes("goodbye")) {
                        response = userName ? `Goodbye, ${userName}! ${getSynonym("Have a great day.", ["Take care.", "See you later."])}` 
                                          : `${getSynonym("Goodbye!", ["Farewell!", "See you!"])} Have a wonderful day.`;
                    } else if (lowerPrompt.includes("time")) {
                        response = `The current time is ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}.`;
                    } else if (lowerPrompt.includes("date")) {
                        response = `Today's date is ${new Date().toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.`;
                    } else if (lowerPrompt.includes("thank you") || lowerPrompt.includes("thanks")) {
                        response = `${getSynonym("You're welcome!", ["No problem!", "Happy to help!"])} ${getSynonym("Is there anything else?", ["What else can I do for you?", "Need help with anything more?"])}`;
                    } else {
                        // Temperature-based response variation
                        if (aiTemperature === "creative" && Math.random() > 0.5) {
                            const creativePrefixes = ["That's a fascinating thought!", "Let me ponder that...", "Hmm, interesting perspective."];
                            response = `${creativePrefixes[Math.floor(Math.random() * creativePrefixes.length)]} I'm still learning about complex topics.`;
                        } else if (aiTemperature === "safe") {
                            response = "I understand. I'm designed to provide helpful and safe responses.";
                        } else { // Balanced (default)
                            const thoughtfulResponses = [
                                `That's an interesting question, ${userName || 'friend'}.`,
                                `I'll have to think about that one, ${userName || 'friend'}.`,
                                `Tell me more about what you're thinking, ${userName || 'friend'}.`
                            ];
                            if (userName || conversationHistory.length > 4) { // Slightly more engaging if context exists
                                response = thoughtfulResponses[Math.floor(Math.random() * thoughtfulResponses.length)];
                            }
                        }
                    }
                }
                return response;
            }
            
            function getJoke() {
                const jokes = [
                    "Why don't scientists trust atoms? Because they make up everything!",
                    "Why did the scarecrow win an award? Because he was outstanding in his field!",
                    "What do you call fake spaghetti? An Impasta!",
                    "Why did the bicycle fall over? Because it was two-tired!"
                ];
                return jokes[Math.floor(Math.random() * jokes.length)];
            }

            // --- HANDLE SEND MESSAGE ---
            async function handleSendMessage(event) {
                if (event) event.preventDefault(); // Prevent form submission & page reload
                const messageText = userInput.value.trim();
                if (messageText === '') return;

                addMessageToChat(messageText, 'user');
                conversationHistory.push({ role: 'user', content: messageText });
                userInput.value = ''; 

                const aiResponseText = await getAIResponse(messageText);
                addMessageToChat(aiResponseText, 'bot');
                conversationHistory.push({ role: 'assistant', content: aiResponseText });
            }

            // --- EVENT LISTENERS ---
            chatForm.addEventListener('submit', handleSendMessage);

            themeToggleButton.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                updateThemePreference();
            });
            
            // Mobile Keyboard Pushback (Basic - ensure scroll after viewport changes slightly)
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    // Only scroll if input is focused, suggesting keyboard is likely cause
                    if (document.activeElement === userInput) {
                         scrollToBottom();
                    }
                });
            }


            // --- THEME MANAGEMENT ---
            function updateThemePreference() {
                const isDarkMode = document.body.classList.contains('dark-mode');
                if (isDarkMode) {
                    themeToggleIcon.textContent = '☀️'; // Sun icon
                    themeToggleText.textContent = 'Light Mode';
                    localStorage.setItem('theme', 'dark');
                } else {
                    themeToggleIcon.textContent = '🌙'; // Moon icon
                    themeToggleText.textContent = 'Dark Mode';
                    localStorage.setItem('theme', 'light');
                }
            }

            function loadTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode'); // Default to light
                }
                updateThemePreference(); // Update button text/icon
            }
            
            // --- VOICE INPUT & TTS (PLACEHOLDERS) ---
            /*
            function startVoiceInput() {
                if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    recognition.interimResults = false;
                    recognition.lang = 'en-US';
                    
                    recognition.onstart = () => {
                        console.log("Voice recognition started. Speak into the microphone.");
                        userInput.placeholder = "Listening...";
                    };
                    
                    recognition.onspeechend = () => {
                        recognition.stop();
                        userInput.placeholder = "Type your message...";
                    };
                    
                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        userInput.value = transcript;
                        handleSendMessage(); // Optionally send immediately
                    };
                    
                    recognition.onerror = (event) => {
                        console.error("Speech recognition error", event.error);
                        userInput.placeholder = "Voice input error. Type your message...";
                    };
                    
                    recognition.start();
                } else {
                    console.log("Speech recognition not supported in this browser.");
                    alert("Sorry, your browser doesn't support voice input.");
                }
            }

            function speakText(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    // You can configure voice, pitch, rate here if desired
                    // utterance.voice = speechSynthesis.getVoices().find(voice => voice.name === 'Google UK English Female');
                    // utterance.pitch = 1;
                    // utterance.rate = 1;
                    speechSynthesis.speak(utterance);
                } else {
                    console.log("Text-to-speech not supported in this browser.");
                }
            }
            // Example: To make the bot speak its response:
            // Inside getAIResponse, before returning 'response':
            // speakText(response); 
            // And you'd need a button to trigger startVoiceInput()
            */

            // --- INITIALIZE ---
            initializeChat();
        });
    </script>
</body>
</html>
