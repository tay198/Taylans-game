<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Evidence Lockdown: Rhythm Scan</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #0A0A0A;
      color: #E0E0E0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    canvas {
      display: block;
      background-color: #181818;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let screenWidth, screenHeight;
    let gameRunning = false;
    let animationFrameId;

    const BEATS_PER_MINUTE = 90;
    const BEAT_INTERVAL = 60000 / BEATS_PER_MINUTE;
    let lastBeatTime = 0;
    let beatCount = 0;

    const SCANNER_COLOR = 'rgba(0, 255, 255, 0.7)';
    const SCANNER_WIDTH = 8;
    let scannerX = 0;
    const SCANNER_SPEED_PIXELS_PER_MS = 0.15;
    let scannerDirection = 1;
      let items = [];
    const ITEM_RADIUS = 15;
    const EVIDENCE_COLOR = 'rgba(0, 255, 0, 0.8)';
    const DISTRACTOR_COLOR = 'rgba(255, 165, 0, 0.8)';
    const ITEM_SPAWN_CHANCE_PER_BEAT = 0.6;
    const DISTRACTOR_SPAWN_CHANCE = 0.3;
    const ITEM_ACTIVE_DURATION_MS = BEAT_INTERVAL * 3.5;
    const PERFECT_TAP_WINDOW_MS = BEAT_INTERVAL / 3;

    let score = 0;
    let highScore = localStorage.getItem('evidenceLockdownHighScore') || 0;
    let combo = 0;
    const SCORE_PER_EVIDENCE = 100;
    const COMBO_MULTIPLIER_BONUS = 10;
    const PENALTY_FOR_DISTRACTOR = -150;
    const PENALTY_FOR_MISS = -50;

    let tapFeedback = [];
    let lives = 3;
    const INITIAL_LIVES = 3;

    function getRandom(min, max) { return Math.random() * (max - min) + min; }
    function lerp(start, end, amt) { return (1 - amt) * start + amt * end; }

    function resizeCanvas() {
      screenWidth = window.innerWidth;
      screenHeight = window.innerHeight;
      canvas.width = screenWidth;
      canvas.height = screenHeight;
      scannerX = SCANNER_WIDTH / 2;
      draw();
    }

    function handleTap(event) {
      if (event) event.preventDefault();
      if (!gameRunning) {
        startGame();
        return;
      }

      const tapTime = performance.now();
      let itemHit = false;

      for (let i = items.length - 1; i >= 0; i--) {
        const item = items[i];
        const distanceToScanner = Math.abs(item.x - scannerX);

        if (distanceToScanner < item.radius + SCANNER_WIDTH &&
          Math.abs(tapTime - item.spawnTime - (ITEM_ACTIVE_DURATION_MS / 2)) < PERFECT_TAP_WINDOW_MS * 2) {
          
          if (scannerX >= item.x - item.radius && scannerX <= item.x + item.radius &&
              tapTime >= item.spawnTime && tapTime <= item.spawnTime + ITEM_ACTIVE_DURATION_MS) {
            
            if (item.type === 'evidence') {
              score += SCORE_PER_EVIDENCE + (combo * COMBO_MULTIPLIER_BONUS);
              combo++;
              addTapFeedback(item.x, item.y, `+${SCORE_PER_EVIDENCE + ((combo - 1) * COMBO_MULTIPLIER_BONUS)}`, EVIDENCE_COLOR, tapTime);
              
              const timingAccuracy = Math.abs(tapTime - (item.spawnTime + BEAT_INTERVAL));
              if (timingAccuracy < PERFECT_TAP_WINDOW_MS / 2) {
                score += 50;
                addTapFeedback(item.x, item.y - 20, `Perfect! +50`, SCANNER_COLOR, tapTime);
              }
            } else {
              score += PENALTY_FOR_DISTRACTOR;
              combo = 0;
              lives--;
              addTapFeedback(item.x, item.y, `${PENALTY_FOR_DISTRACTOR}`, DISTRACTOR_COLOR, tapTime);
            }

            items.splice(i, 1);
            itemHit = true;
            break;
          }
        }
      }

      if (!itemHit) {
        // Optionally show miss feedback here
      }

      if (lives <= 0) gameOver();
    }

    function addTapFeedback(x, y, text, color, time) {
      tapFeedback.push({ x, y, text, color, spawnTime: time, alpha: 1 });
    }

    function spawnItem(currentTime) {
      if (Math.random() > ITEM_SPAWN_CHANCE_PER_BEAT) return;

      const type = Math.random() < DISTRACTOR_SPAWN_CHANCE ? 'distractor' : 'evidence';
      const x = getRandom(ITEM_RADIUS * 2, screenWidth - ITEM_RADIUS * 2);
      const y = getRandom(ITEM_RADIUS * 2, screenHeight - ITEM_RADIUS * 2);

      for (const existingItem of items) {
        const dist = Math.hypot(existingItem.x - x, existingItem.y - y);
        if (dist < ITEM_RADIUS * 4) return;
      }

      items.push({
        x, y,
        radius: ITEM_RADIUS,
        type,
        color: type === 'evidence' ? EVIDENCE_COLOR : DISTRACTOR_COLOR,
        spawnTime: currentTime,
        alpha: 0
      });
    }
      function updateItems(currentTime, deltaTime) {
      for (let i = items.length - 1; i >= 0; i--) {
        const item = items[i];

        if (item.alpha < 1) {
          item.alpha += (deltaTime / (BEAT_INTERVAL / 2));
          if (item.alpha > 1) item.alpha = 1;
        }

        if (currentTime > item.spawnTime + ITEM_ACTIVE_DURATION_MS) {
          if (item.type === 'evidence') {
            score += PENALTY_FOR_MISS;
            combo = 0;
            lives--;
            addTapFeedback(item.x, item.y, 'Missed!', DISTRACTOR_COLOR, currentTime);
          }
          items.splice(i, 1);
        }
      }

      if (lives <= 0 && gameRunning) {
        gameOver();
      }
    }

    function updateScanner(deltaTime) {
      scannerX += SCANNER_SPEED_PIXELS_PER_MS * deltaTime * scannerDirection;

      if (scannerX - SCANNER_WIDTH / 2 > screenWidth) {
        scannerX = screenWidth - SCANNER_WIDTH / 2;
        scannerDirection = -1;
      } else if (scannerX + SCANNER_WIDTH / 2 < 0) {
        scannerX = SCANNER_WIDTH / 2;
        scannerDirection = 1;
      }
    }

    function drawBackground() {
      ctx.fillStyle = '#181818';
      ctx.fillRect(0, 0, screenWidth, screenHeight);
    }

    function drawScanner() {
      ctx.fillStyle = SCANNER_COLOR;
      ctx.fillRect(scannerX - SCANNER_WIDTH / 2, 0, SCANNER_WIDTH, screenHeight);

      const timeSinceLastBeat = performance.now() - lastBeatTime;
      const pulseProgress = Math.min(1, timeSinceLastBeat / BEAT_INTERVAL);
      const pulseAlpha = Math.sin(pulseProgress * Math.PI) * 0.3;

      ctx.fillStyle = `rgba(0, 255, 255, ${pulseAlpha})`;
      ctx.fillRect(scannerX - SCANNER_WIDTH * 2, 0, SCANNER_WIDTH * 4, screenHeight);
    }

    function drawItems(currentTime) {
      items.forEach(item => {
        const age = currentTime - item.spawnTime;
        const pulsate = Math.sin(age / (BEAT_INTERVAL / 2) * Math.PI) * 0.2 + 0.8;
        const currentRadius = item.radius * pulsate * item.alpha;

        ctx.beginPath();
        ctx.arc(item.x, item.y, currentRadius, 0, Math.PI * 2);
        ctx.fillStyle = item.color.replace(/, [0-9.]+\)/, `, ${item.alpha * (item.type === 'evidence' ? 0.8 : 0.6)})`);
        ctx.fill();

        const timeToPerfect = item.spawnTime + BEAT_INTERVAL - currentTime;
        if (item.type === 'evidence' && timeToPerfect > 0 && timeToPerfect < PERFECT_TAP_WINDOW_MS * 1.5) {
          ctx.strokeStyle = `rgba(255, 255, 0, ${0.5 * item.alpha * (1 - timeToPerfect / (PERFECT_TAP_WINDOW_MS * 1.5))})`;
          ctx.lineWidth = 3;
          ctx.stroke();
        }
      });
    }

    function drawUI() {
      ctx.fillStyle = '#E0E0E0';
      const fontSize = Math.max(18, screenWidth * 0.025);
      ctx.font = `${fontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
      ctx.textAlign = 'left';
      ctx.fillText(`Score: ${score}`, 20, fontSize * 1.5);
      ctx.fillText(`Lives: ${lives}`, 20, fontSize * 3);

      ctx.textAlign = 'right';
      ctx.fillText(`High Score: ${highScore}`, screenWidth - 20, fontSize * 1.5);
      if (combo > 1) {
        ctx.fillStyle = SCANNER_COLOR;
        ctx.fillText(`Combo: x${combo}`, screenWidth - 20, fontSize * 3);
      }
    }

    function drawTapFeedback(currentTime) {
      for (let i = tapFeedback.length - 1; i >= 0; i--) {
        const fb = tapFeedback[i];
        const age = currentTime - fb.spawnTime;
        const fadeDuration = 800;

        if (age > fadeDuration) {
          tapFeedback.splice(i, 1);
          continue;
        }

        fb.alpha = 1 - (age / fadeDuration);
        const yPos = fb.y - (age / 20);

        ctx.font = `bold ${Math.max(16, screenWidth * 0.02)}px Arial`;
        ctx.fillStyle = fb.color.replace(/, [0-9.]+\)/, `, ${fb.alpha})`);
        ctx.textAlign = 'center';
        ctx.fillText(fb.text, fb.x, yPos);
      }
    }
      function drawMessages(mainText, subText1, subText2 = "") {
      ctx.fillStyle = 'rgba(10, 10, 10, 0.75)';
      ctx.fillRect(0, 0, screenWidth, screenHeight);

      ctx.fillStyle = '#E0E0E0';
      ctx.textAlign = 'center';

      const mainFontSize = Math.max(30, screenWidth * 0.06);
      const subFontSize = Math.max(18, screenWidth * 0.035);

      ctx.font = `bold ${mainFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
      ctx.fillText(mainText, screenWidth / 2, screenHeight / 2 - mainFontSize * 0.8);

      ctx.font = `${subFontSize}px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`;
      ctx.fillText(subText1, screenWidth / 2, screenHeight / 2 + subFontSize);
      if (subText2) {
        ctx.fillText(subText2, screenWidth / 2, screenHeight / 2 + subFontSize * 2.5);
      }
    }

    let lastTime = 0;
    function gameLoop(currentTime) {
      if (!gameRunning) {
        if (lives <= 0) drawMessages("Game Over!", `Final Score: ${score}`, "Tap to Restart");
        return;
      }
      animationFrameId = requestAnimationFrame(gameLoop);

      const deltaTime = currentTime - lastTime;
      lastTime = currentTime;

      if (currentTime - lastBeatTime >= BEAT_INTERVAL) {
        lastBeatTime = currentTime - ((currentTime - lastBeatTime) % BEAT_INTERVAL);
        beatCount++;
        spawnItem(currentTime);
      }

      updateScanner(deltaTime);
      updateItems(currentTime, deltaTime);
      draw();
      drawTapFeedback(currentTime);
    }

    function draw() {
      ctx.clearRect(0, 0, screenWidth, screenHeight);
      drawBackground();
      drawScanner();
      drawItems(performance.now());
      drawUI();
    }

    function startGame() {
      score = 0;
      combo = 0;
      lives = INITIAL_LIVES;
      items = [];
      tapFeedback = [];
      beatCount = 0;

      scannerX = SCANNER_WIDTH / 2;
      scannerDirection = 1;
      lastBeatTime = performance.now();
      lastTime = performance.now();
      gameRunning = true;

      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      gameLoop(performance.now());
    }

    function gameOver() {
      gameRunning = false;
      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('evidenceLockdownHighScore', highScore);
      }
      draw();
      drawMessages("Game Over!", `Final Score: ${score}`, "Tap to Restart");
    }

    function init() {
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      canvas.addEventListener('mousedown', handleTap);
      canvas.addEventListener('touchstart', handleTap, { passive: false });
      drawMessages("Evidence Lockdown", "Tap Screen to Start Scan", `High Score: ${highScore}`);
    }

    init();
  </script>
</body>
</html>
