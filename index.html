<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AI ChatBot by Taylan</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" data-manual></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js" data-manual></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js" data-manual></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js" data-manual></script>
    <style>
        :root {
            --body-bg-light: #f4f6f8; --body-bg-dark: #0d1117;
            --chat-bg-light: #ffffff; --chat-bg-dark: #161b22;
            --header-bg-light: #007bff; --header-bg-dark: #1f6feb;
            --header-text-light: #ffffff; --header-text-dark: #c9d1d9;
            --user-msg-bg-light: #007bff; --user-msg-bg-dark: #1f6feb;
            --user-msg-text-light: #ffffff; --user-msg-text-dark: #e0e0e0;
            --bot-msg-bg-light: #e9ecef; --bot-msg-bg-dark: #21262d;
            --bot-msg-text-light: #333333; --bot-msg-text-dark: #c9d1d9;
            --input-bg-light: #ffffff; --input-bg-dark: #0d1117;
            --input-text-light: #333333; --input-text-dark: #c9d1d9;
            --input-border-light: #ced4da; --input-border-dark: #30363d;
            --button-bg-light: #007bff; --button-bg-dark: #238636;
            --button-text-light: #ffffff; --button-text-dark: #ffffff;
            --text-color-light: #212529; --text-color-dark: #c9d1d9;
            --border-color-light: #dee2e6; --border-color-dark: #30363d;
            --shadow-light: 0 2px 10px rgba(0,0,0,0.075);
            --shadow-dark: 0 3px 12px rgba(0,0,0,0.25);
            --focus-ring-light: rgba(0,123,255,0.25);
            --focus-ring-dark: rgba(31,111,235,0.4);
            --suggestion-bg-light: #e0e0e0; --suggestion-bg-dark: #2a2a2a;
            --suggestion-text-light: #333; --suggestion-text-dark: #ccc;

            /* Default vars that themes will override */
            --body-bg: var(--body-bg-light);
            --chat-bg: var(--chat-bg-light);
            --header-bg: var(--header-bg-light);
            --header-text: var(--header-text-light);
            --user-msg-bg: var(--user-msg-bg-light);
            --user-msg-text: var(--user-msg-text-light);
            --bot-msg-bg: var(--bot-msg-bg-light);
            --bot-msg-text: var(--bot-msg-text-light);
            --input-bg: var(--input-bg-light);
            --input-text: var(--input-text-light);
            --input-border: var(--input-border-light);
            --button-bg: var(--button-bg-light);
            --button-text: var(--button-text-light);
            --text-color: var(--text-color-light);
            --border-color: var(--border-color-light);
            --shadow: var(--shadow-light);
            --focus-ring: var(--focus-ring-light);
            --suggestion-bg: var(--suggestion-bg-light);
            --suggestion-text: var(--suggestion-text-light);
            --custom-persona-accent-color: var(--header-bg);
        }

        body.dark-mode {
            --body-bg: var(--body-bg-dark);
            --chat-bg: var(--chat-bg-dark);
            --header-bg: var(--header-bg-dark);
            --header-text: var(--header-text-dark);
            --user-msg-bg: var(--user-msg-bg-dark);
            --user-msg-text: var(--user-msg-text-dark);
            --bot-msg-bg: var(--bot-msg-bg-dark);
            --bot-msg-text: var(--bot-msg-text-dark);
            --input-bg: var(--input-bg-dark);
            --input-text: var(--input-text-dark);
            --input-border: var(--input-border-dark);
            --button-bg: var(--button-bg-dark);
            --button-text: var(--button-text-dark);
            --text-color: var(--text-color-dark);
            --border-color: var(--border-color-dark);
            --shadow: var(--shadow-dark);
            --focus-ring: var(--focus-ring-dark);
            --suggestion-bg: var(--suggestion-bg-dark);
            --suggestion-text: var(--suggestion-text-dark);
            --custom-persona-accent-color: var(--header-bg-dark);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        html { height: 100%; }
        body { background-color: var(--body-bg); color: var(--text-color); display: flex; flex-direction: row; min-height: 100%; transition: background-color 0.3s, color 0.3s; }
        .threads-sidebar { width: 250px; background-color: var(--chat-bg); border-right: 1px solid var(--border-color); padding: 15px; display: flex; flex-direction: column; transition: background-color 0.3s, border-color 0.3s; display: none; }
        .threads-sidebar h3 { margin-bottom: 10px; font-size: 1.1em; color: var(--text-color); }
        .threads-sidebar ul { list-style: none; }
        .threads-sidebar li button { width: 100%; text-align: left; padding: 8px; margin-bottom: 5px; background: none; border: 1px solid transparent; color: var(--text-color); border-radius: 5px; cursor: pointer; }
        .threads-sidebar li button:hover, .threads-sidebar li button.active { background-color: var(--bot-msg-bg); border-color: var(--button-bg); }
        #newThreadButton { margin-top: auto; padding: 10px; }
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; height: 100dvh; }
        .chat-container { width: 100%; max-width: 100%; flex-grow: 1; background-color: var(--chat-bg); box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; transition: background-color 0.3s; }
        .chat-container.flash { animation: subtleBackgroundFlash 0.5s ease-out forwards; }
        @keyframes subtleBackgroundFlash { 0% { background-color: var(--chat-bg); } 25% { background-color: color-mix(in srgb, var(--chat-bg) 95%, var(--button-bg) 5%); } 100% { background-color: var(--chat-bg); } }
        .chat-header { padding: 10px 15px; background-color: var(--header-bg); color: var(--header-text); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); transition: all 0.3s; flex-shrink: 0; }
        .chat-header h2 { font-size: 1.1em; margin: 0; display: flex; flex-direction: column; align-items: flex-start; }
        .chat-header h2 .title-main { line-height: 1; }
        .chat-header h2 .title-subtitle { font-size: 0.65em; font-weight: normal; opacity: 0.85; margin-top: 2px; line-height: 1; }
        .header-controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .header-controls label { font-size: 0.8em; margin-left: 5px; }
        .header-controls select, .header-controls button { padding: 5px 8px; border-radius: 5px; border: 1px solid var(--header-text); background-color: var(--header-bg); color: var(--header-text); font-size: 0.8em; cursor: pointer; }
        .header-controls button:hover { opacity: 0.8; }
        .header-controls button .text { margin-left: 4px; }
        @media (max-width: 700px) { .header-controls button .text { display: none; } .header-controls label { margin-left: 2px; } .header-controls { gap: 5px; } }
        .chat-window { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; scrollbar-width: thin; scrollbar-color: var(--button-bg) var(--chat-bg); }
        .chat-window::-webkit-scrollbar { width: 8px; }
        .chat-window::-webkit-scrollbar-track { background: var(--chat-bg); }
        .chat-window::-webkit-scrollbar-thumb { background-color: var(--button-bg); border-radius: 10px; border: 2px solid var(--chat-bg); }
        .message { padding: 10px 15px; border-radius: 18px; max-width: 80%; line-height: 1.5; opacity: 0; transform: translateY(10px); animation: fadeInMessage 0.4s cubic-bezier(0.25, 0.1, 0.25, 1) forwards; word-wrap: break-word; position: relative; }
        @keyframes fadeInMessage { 0% { opacity: 0; transform: translateY(15px) scale(0.95); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        .message.fade-out { animation: fadeOutMessage 0.3s ease forwards; }
        @keyframes fadeOutMessage { to { opacity: 0; transform: translateY(-5px); height: 0; padding:0; margin:0; border:0; } }
        .message.user { background-color: var(--user-msg-bg); color: var(--user-msg-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .message.bot { background-color: var(--bot-msg-bg); color: var(--bot-msg-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        .message-actions { position: absolute; bottom: -5px; right: -5px; display: none; gap: 3px; background-color: var(--chat-bg); padding:3px; border-radius: 5px; box-shadow: var(--shadow); }
        .message:hover .message-actions { display: flex; }
        .message-actions button { background: none; border: none; cursor: pointer; font-size: 0.9em; padding: 3px; }
        .message-actions button:hover { opacity: 0.7; }
        .message.bot.loading { display: flex; align-items: center; background-color: var(--bot-msg-bg); color: var(--bot-msg-text); padding: 10px 15px; border-radius: 18px; border-bottom-left-radius: 5px; align-self: flex-start; }
        .loading-spinner { width: 20px; height: 20px; border: 3px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .suggestions-container, .commands-suggestion-container { padding: 5px 15px 10px; display: flex; flex-wrap: wrap; gap: 8px; border-bottom: 1px solid var(--border-color); }
        .suggestions-container button, .commands-suggestion-container button { padding: 6px 10px; border-radius: 15px; border: 1px solid var(--input-border); background-color: var(--suggestion-bg); color: var(--suggestion-text); font-size: 0.85em; cursor: pointer; transition: background-color 0.2s; }
        .suggestions-container button:hover, .commands-suggestion-container button:hover { opacity: 0.8; }
        .commands-suggestion-container { border-top: 1px solid var(--border-color); border-bottom: none; padding-top:10px; }
        .chat-input-form { display: flex; padding: 10px 15px; border-top: 1px solid var(--border-color); background-color: var(--chat-bg); transition: all 0.3s; flex-shrink: 0; align-items: center; }
        #micButton, #imageUploadButton { padding: 8px 10px; margin-right: 8px; border-radius: 50%; background-color: transparent; border: 1px solid var(--input-border); color: var(--text-color); cursor: pointer; font-size: 1.1em; }
        #micButton:hover, #imageUploadButton:hover { background-color: var(--bot-msg-bg); }
        #micButton.recording { background-color: #ff4d4dcc; color: white; }
        #userInput { flex-grow: 1; padding: 10px 15px; border: 1px solid var(--input-border); border-radius: 20px; font-size: 1em; background-color: var(--input-bg); color: var(--input-text); transition: all 0.3s; margin-right: 8px; }
        #userInput:focus, #sendButton:focus, #theme-toggle:focus, #micButton:focus, #imageUploadButton:focus { outline: none; border-color: var(--button-bg); box-shadow: 0 0 0 3px var(--focus-ring); }
        #sendButton { padding: 10px 18px; background-color: var(--button-bg); color: var(--button-text); border: none; border-radius: 20px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.2s; }
        #sendButton:hover:not(:disabled) { opacity:0.85; }
        #sendButton:disabled { background-color:color-mix(in srgb,var(--button-bg) 40%,#88888890); cursor:not-allowed; opacity:.6; }
        .message pre { white-space: pre-wrap; background-color: #2d2d2d; color: #f0f0f0; padding: 10px; border-radius: 5px; margin: 5px 0; overflow-x: auto;}
        .message code { font-family: 'Courier New', Courier, monospace; }
        .message blockquote { border-left: 3px solid #ccc; padding-left: 10px; margin-left: 5px; color: #888; }
        .dark-mode .message pre { background-color: #1e1e1e; border: 1px solid #333; }
        .dark-mode .message blockquote { border-left-color: #555; color: #aaa; }
        .info-tooltip { display: inline-block; width: 14px; height: 14px; border-radius: 50%; background-color: var(--button-bg); color: var(--button-text); text-align: center; font-size: 10px; line-height: 14px; margin-left: 4px; cursor: help; user-select: none; }
        .rps-modal, #customPersonaModal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--chat-bg); color: var(--text-color); padding: 25px; border-radius: 12px; box-shadow: var(--shadow-dark); z-index: 1001; border: 1px solid var(--border-color); max-width: 90vw; }
        .rps-modal button, #customPersonaModal input, #customPersonaModal button { padding: 10px 15px; cursor: pointer; border-radius: 5px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--input-text); font-size: 0.95em; }
        .rps-modal button:hover, #customPersonaModal button:hover { opacity:0.8; }
        #customPersonaModal { width: 380px; display: flex; flex-direction: column; gap: 12px; }
        #customPersonaModal label { font-size: 0.9em; margin-bottom: -8px; }
        #customPersonaModal input { width: 100%;}
        #customPersonaModal h3 { text-align:center; margin-bottom:10px; color: var(--text-color);}
        #customPersonaModal div { display:flex; justify-content: space-between; margin-top:15px; gap: 10px;}
        #customPersonaModal div button { flex-grow: 1; }
        #customPersonaModal button#savePersonaBtn { background-color: var(--button-bg); color: var(--button-text); }
        @media (min-width: 769px) { .threads-sidebar { display: flex; } }
        @media (max-width: 800px) { .chat-area { border-radius: 0; margin: 0; } }
    </style>
</head>
<body>
    <aside class="threads-sidebar" id="threadsSidebar">
        <h3>Chat Threads</h3>
        <ul id="threadList"></ul>
        <button id="newThreadButton" class="header-controls button">New Chat</button>
    </aside>
    <main class="chat-area">
        <div class="chat-container" id="chatAppContainer">
            <header class="chat-header">
                <h2>
                    <span class="title-main">AI Assistant</span>
                    <span class="title-subtitle">by Taylan</span>
                </h2>
                <div class="header-controls">
                    <label for="personaSelect">Persona:</label>
                    <select id="personaSelect">
                        <option value="helpful">Hey my name is robot Tay</option>
                        </select>
                    <button id="exportChatButton" aria-label="Export chat">Export</button>
                    <button id="theme-toggle" aria-label="Toggle color theme">
                        <span class="icon"></span>
                        <span class="text">Theme</span>
                    </button>
                </div>
            </header>
            <div id="xpContainer" style="max-width: 400px; margin: 10px auto 10px; padding: 0 15px;">
              <div id="xpText" style="text-align: center; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; color: var(--text-color);">
                Level 1 — 0/100 XP
              </div>
              <div style="background: var(--input-border); height: 14px; border-radius: 7px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);">
                <div id="xpBar" style="height: 100%; width: 0%; background: linear-gradient(to right, #00e676, #00c853); transition: width 0.4s ease-in-out;"></div>
              </div>
            </div>
            <div class="suggestions-container" id="suggestionsContainer"></div>
            <div class="commands-suggestion-container" id="commandsSuggestionContainer" style="display: none;"></div>
            <div class="chat-window" id="chatWindow" role="log" aria-live="polite"></div>
            <form class="chat-input-form" id="chatForm">
                <button type="button" id="micButton" aria-label="Use microphone">🎤</button>
                <input type="text" id="userInput" placeholder="Ask me anything or type /help..." autocomplete="off" aria-label="User message input" role="textbox">
                <button type="submit" id="sendButton" aria-label="Send message">Send</button>
            </form>
        </div>
    </main>

    <script type="module" defer>
        // --- XP and Leveling System ---
        let userXP = parseInt(localStorage.getItem('userXP')) || 0;
        let userLevel = parseInt(localStorage.getItem('userLevel')) || 1;

        function getRequiredXP(level) {
          return 100 + (level - 1) * 20; // XP required grows per level
        }

        function updateXPUI() {
          const xpBar = document.getElementById("xpBar");
          const xpText = document.getElementById("xpText");
          const xpContainer = document.getElementById("xpContainer");

          if (!xpBar || !xpText || !xpContainer) {
              console.warn("XP UI elements not found. Skipping XP update.");
              return;
          }
          xpContainer.style.display = ""; 
          const xpNeeded = getRequiredXP(userLevel);
          const progress = Math.min(100, Math.floor((userXP / xpNeeded) * 100));
          xpBar.style.width = progress + "%";
          xpText.textContent = `Level ${userLevel} — ${userXP}/${xpNeeded} XP`;
        }

        function gainXPFromMessage(message) {
          if (!message || typeof message !== 'string') return;
          let xpGain = Math.min(50, 5 + Math.floor(message.length / 15));
          userXP += xpGain;
          const xpRequired = getRequiredXP(userLevel);
          if (userXP >= xpRequired) {
            userXP -= xpRequired; 
            userLevel++;
            showLevelUpEffect(userLevel);
          }
          localStorage.setItem("userXP", JSON.stringify(userXP));
          localStorage.setItem("userLevel", JSON.stringify(userLevel));
          updateXPUI();
        }

        function showLevelUpEffect(level) {
          const popup = document.createElement("div");
          popup.textContent = `🎉 LEVEL UP! You’re now Level ${level}`;
          popup.style.cssText = `
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #00c853; color: white; padding: 12px 24px; font-size: 18px;
            border-radius: 8px; box-shadow: 0 0 10px #00c853; z-index: 9999;
            opacity: 1; transition: opacity 0.8s ease-out, top 0.5s ease-out;
            animation: fadeInAndUp 0.5s ease-out;
          `;
          const keyframes = `@keyframes fadeInAndUp { 0% { opacity: 0; top: 50px; } 100% { opacity: 1; top: 20px; } }`;
          const styleSheet = document.createElement("style");
          styleSheet.type = "text/css";
          styleSheet.innerText = keyframes;
          document.head.appendChild(styleSheet);
          document.body.appendChild(popup);
          setTimeout(() => { popup.style.opacity = 0; popup.style.top = "0px"; }, 2200);
          setTimeout(() => { popup.remove(); if (styleSheet) styleSheet.remove(); }, 3000);
        }
        // --- End XP and Leveling System ---

        const chatAppContainer = document.getElementById('chatAppContainer');
        const chatWindow = document.getElementById('chatWindow');
        const userInput = document.getElementById('userInput');
        const chatForm = document.getElementById('chatForm');
        const sendButton = document.getElementById('sendButton');
        const themeToggleButton = document.getElementById('theme-toggle');
        const themeToggleIcon = themeToggleButton.querySelector('.icon');
        const themeToggleText = themeToggleButton.querySelector('.text');
        const personaSelect = document.getElementById('personaSelect');
        const exportChatButton = document.getElementById('exportChatButton');
        const suggestionsContainer = document.getElementById('suggestionsContainer');
        const commandsSuggestionContainer = document.getElementById('commandsSuggestionContainer');
        const micButton = document.getElementById('micButton');
        const threadsSidebar = document.getElementById('threadsSidebar');
        const threadList = document.getElementById('threadList');
        const newThreadButton = document.getElementById('newThreadButton');

        let conversationHistory = [];
        let currentChatThreadId = localStorage.getItem('lastActiveThreadId') || 'default_chat';
        let userName = localStorage.getItem('userName') || null; 
        let userPreferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
        let initialFocusDone = false;
        const MAX_MESSAGES_DISPLAY = 100;
        let speechRecognition;

        const AVAILABLE_COMMANDS = [
            { cmd: "/help", desc: "Show this help message." },
            { cmd: "/joke", desc: "Tell a joke." },
            { cmd: "/reset", desc: "Reset current chat." },
            { cmd: "/play", desc: "Play Rock, Paper, Scissors." },
            { cmd: "/roll", desc: "Roll a 6-sided die." },
            { cmd: "/quote", desc: "Get an inspirational quote." },
            { cmd: "/createpersona", desc: "Create a new custom persona." },
            { cmd: "/clearxp", desc: "Reset your XP and Level." },
        ];
        
        function handleMiniGames(command) {
            if (command === '/play') {
                const options = ['Rock', 'Paper', 'Scissors'];
                const botChoice = options[Math.floor(Math.random() * options.length)];
                const RPSDrivenModal = document.createElement('div');
                RPSDrivenModal.className = 'rps-modal';
                RPSDrivenModal.innerHTML = `
                    <h4 style="margin-bottom: 15px; text-align: center;">Rock, Paper, or Scissors?</h4>
                    <div style="display: flex; justify-content: space-around; gap: 10px;">
                        <button data-choice="rock">Rock</button>
                        <button data-choice="paper">Paper</button>
                        <button data-choice="scissors">Scissors</button>
                    </div>
                    <button id="rpsCancel" style="margin-top: 15px; display: block; margin-left: auto; margin-right: auto;">Cancel</button>
                `;
                document.body.appendChild(RPSDrivenModal);
                const processRPS = (userChoice) => {
                    if (document.body.contains(RPSDrivenModal)) document.body.removeChild(RPSDrivenModal);
                    if (!userChoice) return;
                    const normalizedUser = userChoice.toLowerCase();
                    const normalizedBot = botChoice.toLowerCase();
                    let resultText = '';
                    if (normalizedUser === normalizedBot) resultText = "It's a tie!";
                    else if (
                        (normalizedUser === 'rock' && normalizedBot === 'scissors') ||
                        (normalizedUser === 'paper' && normalizedBot === 'rock') ||
                        (normalizedUser === 'scissors' && normalizedBot === 'paper')
                    ) resultText = `I chose ${botChoice}. You win! 🎉`;
                    else resultText = `I chose ${botChoice}. You lose! 😢`;
                    const botMessageId = generateMessageId();
                    addMessageToChat(resultText, 'bot', false, botMessageId);
                    updateConversationHistory('assistant', resultText, botMessageId);
                    saveConversation(currentChatThreadId);
                };
                RPSDrivenModal.querySelectorAll('button[data-choice]').forEach(button => {
                    button.onclick = () => processRPS(button.dataset.choice);
                });
                RPSDrivenModal.querySelector('#rpsCancel').onclick = () => {
                    if (document.body.contains(RPSDrivenModal)) document.body.removeChild(RPSDrivenModal);
                };
            }
        }
        function handleDiceRoll() {
            const roll = Math.floor(Math.random() * 6) + 1;
            const result = `🎲 You rolled a ${roll}!`;
            const botMessageId = generateMessageId();
            addMessageToChat(result, 'bot', false, botMessageId);
            updateConversationHistory('assistant', result, botMessageId);
            saveConversation(currentChatThreadId);
        }
        function handleQuoteCommand() {
            const quotes = [
                "Believe you can and you're halfway there. - Theodore Roosevelt",
                "The only limit to our realization of tomorrow is our doubts of today. - Franklin D. Roosevelt",
                "Do or do not. There is no try. – Yoda",
                "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
                "Strive not to be a success, but rather to be of value. - Albert Einstein"
            ];
            const quote = quotes[Math.floor(Math.random() * quotes.length)];
            const botMessageId = generateMessageId();
            addMessageToChat(`“${quote}”`, 'bot', false, botMessageId);
            updateConversationHistory('assistant', `“${quote}”`, botMessageId);
            saveConversation(currentChatThreadId);
        }
        const bgMusicAudio = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
        bgMusicAudio.loop = true;
        let isMusicPlaying = JSON.parse(localStorage.getItem('musicPlaying') || 'false');
        let musicToggleButton;
        function toggleBackgroundMusic() {
            isMusicPlaying = !isMusicPlaying;
            if (isMusicPlaying) {
                bgMusicAudio.play().catch(e => console.error("Music play failed:", e));
                if(musicToggleButton) musicToggleButton.innerHTML = '🔊 <span class="text">Mute</span>';
                if(musicToggleButton) musicToggleButton.setAttribute('aria-label', 'Mute background music');
            } else {
                bgMusicAudio.pause();
                if(musicToggleButton) musicToggleButton.innerHTML = '🎶 <span class="text">Music</span>';
                if(musicToggleButton) musicToggleButton.setAttribute('aria-label', 'Play background music');
            }
            localStorage.setItem('musicPlaying', isMusicPlaying);
        }
        function setupMusicToggle() {
            musicToggleButton = document.createElement('button');
            musicToggleButton.id = 'music-toggle';
            musicToggleButton.innerHTML = isMusicPlaying ? '🔊 <span class="text">Mute</span>' : '🎶 <span class="text">Music</span>';
            musicToggleButton.setAttribute('aria-label', isMusicPlaying ? 'Mute background music' : 'Play background music');
            const controls = document.querySelector('.chat-header .header-controls');
            const existingThemeToggle = document.getElementById('theme-toggle');
            if (controls && existingThemeToggle) controls.insertBefore(musicToggleButton, existingThemeToggle);
            else if (controls) controls.appendChild(musicToggleButton);
            musicToggleButton.addEventListener('click', toggleBackgroundMusic);
        }
        let themeChooserSelect;
        const themes = {
            default: { name: "Default", isDarkDefault: false, vars: {} },
            vaporwave: { name: "Vaporwave", isDarkDefault: true, vars: {'--body-bg': '#010122', '--chat-bg': '#050538', '--header-bg': '#FF00FF', '--header-text': '#00FFFF', '--user-msg-bg': '#FF69B4', '--user-msg-text': '#FFFFFF', '--bot-msg-bg': '#9400D3', '--bot-msg-text': '#E0E0E0', '--input-bg': '#010122', '--input-text': '#00FFFF', '--input-border': '#FF00FF', '--button-bg': '#00FFFF', '--button-text': '#050538', '--text-color': '#E0E0E0', '--border-color': '#FF00FF', '--shadow': '0 2px 10px rgba(255,0,255,0.5)', '--focus-ring': 'rgba(0,255,255,0.4)', '--suggestion-bg': '#330033', '--suggestion-text': '#00FFFF'} },
            space: { name: "Outer Space", isDarkDefault: true, vars: {'--body-bg': '#0c0f18', '--chat-bg': '#151a2d', '--header-bg': '#2a3b60', '--header-text': '#e0e7ff', '--user-msg-bg': '#3f51b5', '--user-msg-text': '#ffffff', '--bot-msg-bg': '#1e293b', '--bot-msg-text': '#cbd5e1', '--input-bg': '#0c0f18', '--input-text': '#e0e7ff', '--input-border': '#2a3b60', '--button-bg': '#5c6bc0', '--button-text': '#ffffff', '--text-color': '#cbd5e1', '--border-color': '#2a3b60', '--shadow': '0 3px 12px rgba(0,0,0,0.4)', '--focus-ring': 'rgba(92,107,192,0.4)', '--suggestion-bg': '#1c2541', '--suggestion-text': '#a7c5eb'} },
        };
        function applyTheme(themeName, isExplicitThemeChoice = false) {
            const selectedTheme = themes[themeName] || themes.default;
            const rootStyle = document.documentElement.style;
            if (isExplicitThemeChoice) {
                if (selectedTheme.isDarkDefault) document.body.classList.add('dark-mode');
                else document.body.classList.remove('dark-mode');
            }
            updateThemePreference(); 
            const allThemeVarKeys = new Set();
            Object.values
